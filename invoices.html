<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>EscapePlan – Bill Upload (Incentives)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0b1024">
<style>
  :root{
    --bg1:#050815; --bg2:#0b1024; --stroke:rgba(255,255,255,.14);
    --text:#eaf2ff; --muted:#b3c0d9;
    --accent:#22d3ee; --violet:#7c3aed;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --radius:16px; --shadow:0 16px 48px rgba(7,9,26,.6)
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(1000px 600px at -10% -10%, rgba(34,211,238,.25), transparent 55%),
      radial-gradient(1000px 600px at 110% 10%, rgba(124,58,237,.20), transparent 55%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
    display:flex; flex-direction:column;
  }
  .appbar{position:sticky;top:0;z-index:40;border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(5,8,21,.85), rgba(5,8,21,.65))}
  .appbar-inner{max-width:880px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .logo{width:26px;height:26px;border-radius:50%;
    background:conic-gradient(from 180deg, var(--accent), var(--violet), #f43f5e, var(--accent))}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);
    background:linear-gradient(90deg, rgba(34,211,238,.15), rgba(124,58,237,.15)); cursor:pointer}
  .wrap{max-width:880px;width:100%;margin:18px auto 28px;padding:0 16px;display:grid;gap:16px}
  .panel{border-radius:var(--radius);border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));box-shadow:var(--shadow);overflow:hidden}
  .h{padding:12px 16px;font-weight:900;border-bottom:1px solid var(--stroke)}
  .b{padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 2px}
  .grid{display:grid;gap:12px}
  @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}
  select,input[type="file"],input[type="date"],input[type="number"],input[type="text"]{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(5,8,21,.85), rgba(5,8,21,.75));color:var(--text);font-size:16px
  }
  select:focus,input:focus{outline:none;box-shadow:0 0 0 3px rgba(34,211,238,.22)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid var(--stroke);border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;transition:.2s}
  .btn.primary{color:#0b1024;background:linear-gradient(90deg,#22d3ee,#7c3aed)}
  .btn.alt{color:#eaf2ff;background:linear-gradient(90deg,rgba(124,58,237,.25),rgba(34,211,238,.25))}
  .btn[disabled]{opacity:.55; cursor:not-allowed; filter:saturate(.5)}
  .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06)}
  .ok{color:#d1fae5;border-color:rgba(22,163,74,.35);background:linear-gradient(90deg,rgba(16,185,129,.15),rgba(34,197,94,.1))}
  .warn{color:#ffefcc;border-color:rgba(245,158,11,.35);background:linear-gradient(90deg,rgba(245,158,11,.18),rgba(251,191,36,.12))}
  .bad{color:#ffd6d6;border-color:rgba(239,68,68,.4);background:linear-gradient(90deg,rgba(239,68,68,.20),rgba(239,68,68,.12))}
  .preview{width:100%;max-height:360px;object-fit:contain;border-radius:14px;border:1px solid var(--stroke);background:#000}
  .muted{color:var(--muted);font-size:12px}
  .footer{text-align:center;color:var(--muted);font-size:12px;padding:14px 0 28px}
  .banner{display:none;margin-top:12px;border-radius:14px;padding:14px;border:1px solid var(--stroke)}
  .banner h3{margin:0 0 6px 0;font-size:18px}
  .banner p{margin:0;color:var(--muted);font-size:13px}
  .banner.ok{border-color:rgba(22,163,74,.35);background:linear-gradient(180deg, rgba(16,185,129,.16), rgba(16,185,129,.10))}
  .banner.warn{border-color:rgba(245,158,11,.35);background:linear-gradient(180deg, rgba(245,158,11,.18), rgba(245,158,11,.10))}
  .banner.bad{border-color:rgba(239,68,68,.4);background:linear-gradient(180deg, rgba(239,68,68,.20), rgba(239,68,68,.12))}
  .help{font-size:12px;color:#a7b8d9;margin-top:6px}
</style>
</head>
<body>
<header class="appbar">
  <div class="appbar-inner">
    <div class="brand"><div class="logo"></div>EscapePlan – Bill Upload</div>
    <div class="pill" id="dataStatus" title="Tap to retry">Loading roster…</div>
  </div>
</header>

<main class="wrap">

  <section class="panel">
    <div class="h">Identify Yourself</div>
    <div class="b">
      <div class="grid grid-3">
        <div>
          <label>City</label>
          <select id="city"><option value="">Select City</option></select>
        </div>
        <div>
          <label>Mall</label>
          <select id="mall"><option value="">Select Mall</option></select>
        </div>
        <div>
          <label>Your Name</label>
          <select id="rep"><option value="">Select Your Name</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <span id="empBadge" class="badge" style="display:none"></span>
        <span id="storeIdBadge" class="badge" style="display:none"></span>
        <span id="refBadge" class="badge" style="display:none"></span>
      </div>
      <div class="muted" style="margin-top:8px">Choose City, Mall and Name. Then allow location & camera.</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Bill Details</div>
    <div class="b">
      <div class="grid grid-3">
        <div>
          <label>Transaction Date</label>
          <input id="txDate" type="date">
        </div>
        <div>
          <label>Amount (₹)</label>
          <input id="amount" type="number" inputmode="decimal" min="0" step="0.01" placeholder="0.00">
        </div>
        <div>
          <label>Payment Mode</label>
          <select id="mode">
            <option value="">Select Payment Mode</option>
            <option>Cash</option>
            <option>Card</option>
            <option>UPI</option>
            <option>Wallet</option>
            <option>Other</option>
          </select>
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:10px">
        <div>
          <label>Units (pieces)</label>
          <input id="units" type="number" inputmode="numeric" min="1" step="1" placeholder="e.g. 1">
        </div>
        <div>
          <label>Invoice No. (optional)</label>
          <input id="invoiceNo" type="text" placeholder="e.g. ESC-12345">
        </div>
        <div>
          <label>Customer / Notes (optional)</label>
          <input id="notes" type="text" placeholder="Retailer name or any note">
        </div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Location</div>
    <div class="b">
      <div class="row">
        <button id="locBtn" class="btn primary">Use My Location</button>
        <span id="locStatus" class="badge">Waiting…</span>
      </div>
      <div class="row" style="margin-top:10px">
        <span>Distance to store:</span>
        <strong id="distance" style="font-size:18px;letter-spacing:.3px">— m</strong>
        <span id="proximity" class="badge" style="display:none"></span>
      </div>
      <div class="muted" id="addrLine" style="margin-top:6px"></div>
      <div class="help" id="deniedTip" style="display:none">If location was blocked: tap the lock icon in the address bar → Site settings → Allow location, then reload.</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Invoice Photo</div>
    <div class="b">
      <input id="photo" type="file" accept="image/*" capture="environment">
      <div style="margin-top:10px">
        <img id="preview" class="preview" style="display:none" alt="Preview">
      </div>
      <div class="muted" style="margin-top:6px">Watermark includes name, date, <b>units</b>, amount, mode, GPS & address.</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Submit</div>
    <div class="b">
      <div class="row">
        <button id="submitBtn" class="btn primary" disabled>Submit Bill</button>
        <button id="resetBtn" class="btn alt">Reset</button>
        <span id="readyHint" class="badge">Complete steps to enable</span>
      </div>

      <div id="resultBanner" class="banner">
        <h3 id="bannerTitle">Status</h3>
        <p id="bannerSub"></p>
      </div>

      <div class="muted" style="margin-top:8px">We save server timestamp (IST), inputs, distance/status, address & photo URL.</div>
    </div>
  </section>

  <div class="footer">Privacy: camera & location are used only for this submission.</div>
</main>

<script>
/* ===== CONFIG ===== */
const ROSTER_SHEET_ID = '13od8p_pcVQsMGHVqhoI-bOrW3xDeOKNeM4rf0uc8PX4';
const ROSTER_TAB_NAME = 'Roster';
const GAS_WEBAPP_URL  = 'https://script.google.com/macros/s/AKfycbyeV_GCJwRZi7Qr9QAAPZBEYqzYVyYIoMiQfpdLTduMl4Qr0pNHuouGwuwZ_ILlsOpO/exec';
const ROSTER_URLS = [
  `https://opensheet.elk.sh/${ROSTER_SHEET_ID}/${encodeURIComponent(ROSTER_TAB_NAME)}`,
  `https://opensheet.vercel.app/${ROSTER_SHEET_ID}/${encodeURIComponent(ROSTER_TAB_NAME)}`
];

/* ===== STATE ===== */
let ROSTER = [];
let selected = { city:'', mall:'', rep:'', empId:'', storeId:'', refLat:null, refLon:null };
let userLat = null, userLon = null, lastAccuracy = null;
let watchId = null;
let photoBase64 = '';
let addressText = '';
let clientTsIST = '';

/* ===== HELPERS ===== */
const $ = id => document.getElementById(id);
const t = v => v==null ? '' : String(v).trim();
const num = v => { const x = parseFloat(String(v).replace(/,/g,'')); return Number.isFinite(x)?x:NaN; };
function uniq(a){ return Array.from(new Set(a.filter(x => t(x) !== ''))); }
function haversineMeters(lat1, lon1, lat2, lon2){
  const toRad = d=>d*Math.PI/180, R=6371000;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}
function nowIST(){ return new Date().toLocaleString('en-IN',{ timeZone:'Asia/Kolkata', hour12:false }); }
async function reverseGeocode(lat, lon){
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=16&addressdetails=1`;
    const res = await fetch(url, { headers:{ 'Accept':'application/json' }});
    const j = await res.json();
    return j.display_name || '';
  }catch{ return ''; }
}
async function fetchJsonTry(url, ms=8000){
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), ms);
  try{
    const r = await fetch(url, { headers:{'Accept':'application/json'}, cache:'no-store', signal:ctrl.signal });
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }finally{ clearTimeout(timer); }
}

/* ===== Enable/disable submit ===== */
function updateSubmitEnabled(){
  const amt = num($("amount").value);
  const units = parseInt($("units").value, 10);
  const ready = selected.city && selected.mall && selected.rep &&
                userLat!=null && userLon!=null && !!photoBase64 &&
                $("txDate").value && Number.isFinite(amt) && amt>0 &&
                Number.isFinite(units) && units>0 && $("mode").value;
  $("submitBtn").disabled = !ready;
  $("readyHint").textContent = ready ? "Ready to submit" : "Complete steps to enable";
}

/* ===== LOAD ROSTER ===== */
async function loadRoster(){
  const status = $("dataStatus");
  status.textContent = "Loading roster…";
  try{
    let raw;
    try { raw = await fetchJsonTry(ROSTER_URLS[0]); }
    catch { raw = await fetchJsonTry(ROSTER_URLS[1]); }
    ROSTER = raw.map(row => { const o={}; Object.keys(row).forEach(k=>o[String(k).trim().toLowerCase()]=row[k]); return o; });
    const cities = uniq(ROSTER.map(r => t(r.city)));
    $("city").innerHTML = `<option value="">Select City</option>` + cities.sort().map(c=>`<option>${c}</option>`).join('');
    status.textContent = `Loaded ${ROSTER.length} rows`;
  }catch(e){
    $("city").innerHTML = `<option value="">Failed to load roster</option>`;
    $("dataStatus").textContent = "Load failed — tap to retry";
  }
}
$("dataStatus").addEventListener("click", loadRoster);

/* ===== Cascading filters ===== */
$("city").addEventListener("change", ()=>{
  selected.city = $("city").value;
  const malls = uniq(ROSTER.filter(r => t(r.city)===t(selected.city)).map(r => t(r.mall)));
  $("mall").innerHTML = `<option value="">Select Mall</option>` + malls.sort().map(m=>`<option>${m}</option>`).join('');
  $("rep").innerHTML = `<option value="">Select Your Name</option>`;
  ["empBadge","storeIdBadge","refBadge"].forEach(id => $(id).style.display="none");
  updateSubmitEnabled();
});
$("mall").addEventListener("change", ()=>{
  selected.mall = $("mall").value;
  const reps = uniq(ROSTER.filter(r => t(r.city)===t(selected.city) && t(r.mall)===t(selected.mall)).map(r => t(r.salesperson)));
  $("rep").innerHTML = `<option value="">Select Your Name</option>` + reps.sort().map(r=>`<option>${r}</option>`).join('');
  ["empBadge","storeIdBadge","refBadge"].forEach(id => $(id).style.display="none");
  updateSubmitEnabled();
});
$("rep").addEventListener("change", ()=>{
  selected.rep = $("rep").value;
  const row = ROSTER.find(r => t(r.city)===t(selected.city) && t(r.mall)===t(selected.mall) && t(r.salesperson)===t(selected.rep)) || {};
  selected.empId  = t(row['employee id'] || row['emp id'] || row['employeeid'] || '');
  selected.storeId= t(row['store id'] || '');
  selected.refLat = num(row['ref lat']);
  selected.refLon = num(row['ref lon']);
  if (selected.empId){ $("empBadge").textContent = "Employee ID: " + selected.empId; $("empBadge").style.display="inline-flex"; }
  if (selected.storeId){ $("storeIdBadge").textContent = "Store ID: " + selected.storeId; $("storeIdBadge").style.display="inline-flex"; }
  if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
    $("refBadge").textContent = `Ref: ${selected.refLat.toFixed(5)}, ${selected.refLon.toFixed(5)}`;
    $("refBadge").style.display="inline-flex";
  }
  updateSubmitEnabled();
});

/* ===== GEO ===== */
$("locBtn").addEventListener("click", ()=>{
  if (!navigator.geolocation){ $("locStatus").textContent = "Geolocation not supported"; return; }
  $("locStatus").textContent = "Requesting permission…";
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  watchId = navigator.geolocation.watchPosition(
    async pos=>{
      userLat = pos.coords.latitude; userLon = pos.coords.longitude;
      lastAccuracy = Math.round(pos.coords.accuracy||0);
      clientTsIST = nowIST();
      $("locStatus").textContent = `Live: ${userLat.toFixed(5)}, ${userLon.toFixed(5)} (±${lastAccuracy}m)`;
      if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
        const m = haversineMeters(userLat,userLon,selected.refLat,selected.refLon);
        $("distance").textContent = `${m} m`;
        const p = $("proximity"); p.style.display="inline-flex";
        if (m < 100){ p.textContent="OK (<100m)"; p.className="badge ok"; }
        else if (m<=250){ p.textContent="Check (100–250m)"; p.className="badge warn"; }
        else { p.textContent="Not captured (>250m)"; p.className="badge bad"; }
      }
      addressText = await reverseGeocode(userLat, userLon);
      $("addrLine").textContent = addressText ? `Address: ${addressText}` : '';
      updateSubmitEnabled();
    },
    err=>{
      $("locStatus").textContent = "Location denied or unavailable";
      $("deniedTip").style.display = "block";
    },
    { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
  );
});

/* ===== PHOTO (watermark) ===== */
$("photo").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = async ()=>{
    const img = new Image();
    img.onload = async ()=>{
      const MAX = 1600, s = Math.min(1, MAX/img.width, MAX/img.height);
      const w = Math.round(img.width*s), h = Math.round(img.height*s);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      // Watermark strip
      ctx.fillStyle = 'rgba(0,0,0,0.58)'; ctx.fillRect(0, h-122, w, 122);
      ctx.fillStyle = '#fff'; ctx.font = '16px system-ui, Segoe UI, Roboto, Arial';
      const ts = clientTsIST || nowIST();
      const line0 = `${selected.rep || '—'} • ${selected.city || '-'} / ${selected.mall || '-'}`;
      const line1 = `TX: ${$("txDate").value || '-'} • Units: ${$("units").value || '-'} • ₹${$("amount").value || '-'} • ${$("mode").value || '-'}`;
      const line2 = `${ts} • ${userLat?.toFixed(5)||'-'},${userLon?.toFixed(5)||'-'} (±${lastAccuracy||'-'}m)`;
      const line3 = (addressText||'').slice(0, 80);
      ctx.fillText(line0, 10, h-98);
      ctx.fillText(line1, 10, h-76);
      ctx.fillText(line2, 10, h-54);
      ctx.fillText(line3, 10, h-32);
      photoBase64 = canvas.toDataURL('image/jpeg', 0.85);
      $("preview").src = photoBase64; $("preview").style.display = "block";
      updateSubmitEnabled();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(f);
});

/* ===== Banner ===== */
function showBanner(kind, distance, receiptId){
  const bn = $("resultBanner"), title = $("bannerTitle"), sub = $("bannerSub");
  bn.className = "banner " + (kind==="ok"?"ok":kind==="warn"?"warn":"bad");
  if (kind==="ok"){
    title.textContent = "Bill submitted ✅";
    sub.textContent = distance!=null ? `Distance: ${distance} m${receiptId?` • Receipt: ${receiptId}`:''}` : (receiptId?`Receipt: ${receiptId}`:'');
  } else if (kind==="warn"){
    title.textContent = "Please check ⚠️";
    sub.textContent = `You are ${distance} m from store (100–250 m). Manager may ask to retake.`;
  } else {
    title.textContent = "NOT captured ❌";
    sub.textContent = `You are ${distance} m away. Go to store entrance, reload and retake.`;
  }
  bn.style.display = "block";
}

/* ===== Submit ===== */
$("submitBtn").addEventListener("click", async ()=>{
  const btn = $("submitBtn");
  btn.textContent = "Submitting…"; btn.disabled = true;

  const payload = {
    city: selected.city, mall: selected.mall, salesperson: selected.rep,
    employeeId: selected.empId || '', storeId: selected.storeId || '',
    txDate: $("txDate").value, amount: $("amount").value, paymentMode: $("mode").value,
    units: $("units").value,
    invoiceNo: $("invoiceNo").value, notes: $("notes").value,
    userLat, userLon, accuracy: lastAccuracy, address: addressText,
    clientTimestampIST: clientTsIST || nowIST(),
    photoBase64
  };

  try{
    const res = await fetch(GAS_WEBAPP_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch{ throw new Error('Server not JSON: ' + text.slice(0,120)); }

    if (data.ok){
      const d = typeof data.distanceMeters === 'number' ? data.distanceMeters : null;
      if (d!=null){
        if (d < 100)      showBanner("ok", d, data.receiptId);
        else if (d<=250)  showBanner("warn", d, data.receiptId);
        else              showBanner("bad", d, data.receiptId);
      } else {
        showBanner("ok", null, data.receiptId);
      }
      btn.textContent = "Submitted ✓"; // stays disabled
    } else {
      btn.textContent = "Submit Bill"; btn.disabled = false;
      showBanner("bad", null, null);
      $("bannerTitle").textContent = "Submission failed";
      $("bannerSub").textContent  = (data.error || "Check network and try again.");
    }
  }catch(e){
    btn.textContent = "Submit Bill"; btn.disabled = false;
    showBanner("bad", null, null);
    $("bannerTitle").textContent = "Network error";
    $("bannerSub").textContent  = "Please check your connection and try again.";
  }
});

/* ===== Reset ===== */
$("resetBtn").addEventListener("click", ()=>{
  ["city","mall","rep","mode"].forEach(id => $(id).selectedIndex = 0);
  ["txDate","amount","invoiceNo","notes","units"].forEach(id => $(id).value = '');
  selected = { city:'', mall:'', rep:'', empId:'', storeId:'', refLat:null, refLon:null };
  userLat = userLon = null; lastAccuracy = null; addressText=''; clientTsIST='';
  photoBase64='';
  $("preview").style.display = "none";
  ["empBadge","storeIdBadge","refBadge"].forEach(id => $(id).style.display="none");
  $("locStatus").textContent = "Waiting…"; $("distance").textContent = "— m"; $("proximity").style.display="none"; $("addrLine").textContent='';
  $("resultBanner").style.display = "none";
  $("submitBtn").textContent = "Submit Bill"; $("submitBtn").disabled = true;
  $("readyHint").textContent = "Complete steps to enable";
  $("deniedTip").style.display = "none";
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
});

/* ===== Boot ===== */
(function initDefaults(){
  const today = new Date();
  const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0'), d = String(today.getDate()).padStart(2,'0');
  $("txDate").value = `${y}-${m}-${d}`;
})();
loadRoster();
</script>
</body>
</html>
