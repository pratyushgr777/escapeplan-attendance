<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Retail Dashboard • Demo</title>
<meta name="theme-color" content="#0b1024" />
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<style>
  :root{
    --bg:#0b1024; --panel:#111735; --edge:#1f2950;
    --text:#eaf2ff; --muted:#b6c3dc; --soft:#9fb3d9;
    --accent:#22d3ee; --violet:#7c3aed; --pink:#f43f5e;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --radius:14px
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(900px 700px at -10% -10%, rgba(34,211,238,.22), transparent 55%),
      radial-gradient(900px 700px at 110% 10%, rgba(124,58,237,.18), transparent 55%),
      linear-gradient(160deg, #080c1d, var(--bg));
  }
  .appbar{position:sticky;top:0;z-index:20;border-bottom:1px solid var(--edge);
    background:linear-gradient(180deg, rgba(8,12,29,.95), rgba(8,12,29,.78)); backdrop-filter: blur(6px)}
  .appbar-inner{max-width:1200px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .logo{width:26px;height:26px;border-radius:50%;
    background:conic-gradient(from 180deg, var(--accent), var(--violet), var(--pink), var(--accent))}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--edge);color:var(--soft)}
  .wrap{max-width:1200px;margin:18px auto 28px;padding:0 16px;display:grid;gap:14px}
  .panel{border-radius:var(--radius);border:1px solid var(--edge);background:linear-gradient(180deg,#121a3b,#101633)}
  .h{padding:12px 14px;border-bottom:1px solid var(--edge);font-weight:800}
  .b{padding:14px}
  .filters{display:grid;gap:10px}
  @media(min-width:720px){.filters{grid-template-columns:1fr 1fr 1fr auto}}
  label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
  select,button{
    -webkit-appearance:none; appearance:none;
    width:100%; border:1px solid var(--edge); background:#0f1530; color:var(--text);
    padding:11px 12px; border-radius:12px; font-size:15px; line-height:1.2;
  }
  select:focus,button:focus{outline:none; box-shadow:0 0 0 3px rgba(34,211,238,.25)}
  .btn{cursor:pointer; font-weight:800; background:linear-gradient(90deg,var(--accent),var(--violet)); color:#0b1024}
  .cards{display:grid; gap:10px}
  @media(min-width:880px){.cards{grid-template-columns:repeat(4,1fr)}}
  .card{border:1px solid var(--edge);border-radius:12px;background:#0f1530; padding:12px}
  .card h4{margin:0 0 8px 0; font-size:13px; color:var(--muted)}
  .big{font-size:26px; font-weight:900}
  .sub{color:var(--muted); font-size:12px}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .badge{font-size:11px; padding:6px 8px; border-radius:999px; border:1px solid var(--edge); color:var(--soft)}
  .ok{border-color:rgba(22,163,74,.35); color:#c8f5d8}
  .muted{color:var(--muted); font-size:12px}
  .chartBox{height:320px}
  @media(min-width:720px){.chartBox.tall{height:380px}}
  .spark{height:42px}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{border-bottom:1px solid var(--edge); padding:8px 6px; text-align:left}
  th{color:var(--muted); font-weight:600}
  .footer{text-align:center;color:var(--muted);font-size:12px;padding:10px 0 26px}
</style>
</head>
<body>
<header class="appbar">
  <div class="appbar-inner">
    <div class="brand"><div class="logo"></div>Retail Dashboard (Demo)</div>
    <div class="pill" id="dataStatus">Generating sample data…</div>
  </div>
</header>

<main class="wrap">
  <!-- Filters -->
  <section class="panel">
    <div class="h">Filters</div>
    <div class="b filters">
      <div>
        <label>Mall</label>
        <select id="mallSel"><option>Loading…</option></select>
      </div>
      <div>
        <label>Sales Rep</label>
        <select id="repSel"><option>Loading…</option></select>
      </div>
      <div>
        <label>Date Range</label>
        <select id="rangeSel">
          <option value="60">Last 60 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="14">Last 14 days</option>
          <option value="7">Last 7 days</option>
        </select>
      </div>
      <div style="align-self:end">
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </div>
  </section>

  <!-- KPI cards -->
  <section class="panel">
    <div class="h">Highlights</div>
    <div class="b cards">
      <div class="card">
        <h4>Sales (₹)</h4>
        <div class="big" id="kpiSales">—</div>
        <div class="sub" id="kpiSalesSub"></div>
        <div class="spark"><canvas id="sSpark"></canvas></div>
      </div>
      <div class="card">
        <h4>Footfall</h4>
        <div class="big" id="kpiFF">—</div>
        <div class="sub" id="kpiConv"></div>
        <div class="spark"><canvas id="fSpark"></canvas></div>
      </div>
      <div class="card">
        <h4>Qty</h4>
        <div class="big" id="kpiQty">—</div>
        <div class="sub" id="kpiUPT"></div>
        <div class="spark"><canvas id="qSpark"></canvas></div>
      </div>
      <div class="card">
        <h4>ASP / ATV</h4>
        <div class="big" id="kpiASP">—</div>
        <div class="sub" id="kpiATV"></div>
        <div class="spark"><canvas id="aSpark"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Charts -->
  <section class="panel">
    <div class="h">Daily Sales Trend</div>
    <div class="b">
      <div class="row"><span class="badge" id="scopeBadge">All malls • All reps</span></div>
      <div class="chartBox tall"><canvas id="salesLine"></canvas></div>
      <div class="muted" style="margin-top:8px">Change filters above to see mall/rep-wise trends.</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Mall Comparison (Sales)</div>
    <div class="b">
      <div class="chartBox"><canvas id="mallBars"></canvas></div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Mix: Qty • Bills • Conv%</div>
    <div class="b">
      <div class="chartBox"><canvas id="mixChart"></canvas></div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Rep Leaderboard (current scope)</div>
    <div class="b">
      <table id="repTable">
        <thead><tr><th>Rep</th><th>Sales (₹)</th><th>Qty</th><th>Bills</th><th>ASP</th><th>UPT</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <div class="footer">This is a demo with synthetic data. We’ll wire it to your sheet later.</div>
</main>

<script>
/* ---------- utils ---------- */
const fmtInt = n => n.toLocaleString('en-IN');
const fmtMoney = n => '₹ ' + Math.round(n).toLocaleString('en-IN');
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const rand = (a,b) => Math.random()*(b-a)+a;
const today = new Date(); today.setHours(0,0,0,0);
const byDateAsc = (a,b)=> a.date - b.date;
function groupBy(arr, keyFn){ const m=new Map(); for(const r of arr){ const k=keyFn(r); (m.get(k)||m.set(k,[]).get(k)).push(r) } return m }

/* ---------- synthetic data ---------- */
const state = { days:30, mall:'All', rep:'All' };
const MALLS = ['Vega City','Nexus Mysuru','Nexus Mangalore','Westend Pune','Pacific Ghaziabad','Nexus Amritsar','Nexus NTC','Nexus JTI','1 MG','Select City'];
const REPS = ['Neha','Aman','Sita','Rahul','Ishaan','Meera'];
const REPS_BY_MALL = Object.fromEntries(MALLS.map(m => [m, REPS.sort(()=>Math.random()-0.5).slice(0,4)]));

const data = [];
for (const mall of MALLS){
  for (const rep of REPS_BY_MALL[mall]){
    let baseASP = rand(2200, 5200);
    let baseConv = rand(0.08, 0.18); // 8–18%
    let baseUPT  = rand(1.1, 1.8);
    for (let d=89; d>=0; d--){  // keep 90d history so 60d range looks good
      const date = new Date(today); date.setDate(today.getDate()-d);
      const dayFactor = 0.9 + 0.2*Math.sin((date.getTime()/864e5) * 2*Math.PI/7); // weekly seasonality
      const qty = Math.max(0, Math.round(rand(6, 42)*dayFactor));
      const bills = Math.max(1, Math.round(qty / baseUPT));
      const footfall = Math.round((qty / baseConv) * rand(0.9,1.1));
      const asp = clamp(rand(baseASP*0.9, baseASP*1.1), 1800, 7000);
      const sales = qty * asp;
      data.push({ date, mall, rep, qty, bills, footfall, asp, sales });
    }
  }
}
document.getElementById('dataStatus').textContent = `Loaded ${data.length} rows (demo)`;

/* ---------- filters ---------- */
const mallSel = document.getElementById('mallSel');
const repSel  = document.getElementById('repSel');
const rangeSel= document.getElementById('rangeSel');

function initFilters(){
  mallSel.innerHTML = `<option value="All">All malls</option>` + MALLS.map(m=>`<option>${m}</option>`).join('');
  syncRepOptions();
  rangeSel.value = String(state.days);
}
function syncRepOptions(){
  const reps = state.mall==='All'
    ? Array.from(new Set(data.map(r => r.rep))).sort()
    : REPS_BY_MALL[state.mall].slice().sort();
  repSel.innerHTML = `<option value="All">All reps</option>` + reps.map(r=>`<option>${r}</option>`).join('');
  if (!reps.includes(state.rep)) state.rep='All';
  repSel.value = state.rep;
}
mallSel.addEventListener('change', ()=>{ state.mall=mallSel.value; syncRepOptions(); renderAll(); });
repSel.addEventListener('change', ()=>{ state.rep=repSel.value; renderAll(); });
rangeSel.addEventListener('change', ()=>{ state.days=parseInt(rangeSel.value,10)||30; renderAll(); });
document.getElementById('resetBtn').addEventListener('click', ()=>{
  state.mall='All'; state.rep='All'; state.days=30; initFilters(); renderAll();
});

/* ---------- scope & filter ---------- */
function filterData(){
  const start = new Date(today); start.setDate(today.getDate()-(state.days-1));
  return data.filter(r =>
    r.date >= start &&
    (state.mall==='All' || r.mall===state.mall) &&
    (state.rep==='All'  || r.rep===state.rep)
  );
}

/* ---------- KPIs + sparklines ---------- */
let sparkCharts = {};
function renderKPIs(){
  const rows = filterData().sort(byDateAsc);
  const el = id => document.getElementById(id);

  if (!rows.length){
    ['kpiSales','kpiFF','kpiQty','kpiASP','kpiATV','kpiUPT','kpiConv','kpiSalesSub'].forEach(id => el(id).textContent='—');
    for(const c of Object.values(sparkCharts)){ c?.destroy?.(); }
    sparkCharts = {};
    return;
  }
  const totalSales = rows.reduce((s,r)=>s+r.sales,0);
  const totalQty   = rows.reduce((s,r)=>s+r.qty,0);
  const totalBills = rows.reduce((s,r)=>s+r.bills,0);
  const totalFF    = rows.reduce((s,r)=>s+r.footfall,0);
  const asp = totalQty ? totalSales/totalQty : 0;
  const atv = totalBills ? totalSales/totalBills : 0;
  const upt = totalBills ? totalQty/totalBills : 0;
  const conv = totalFF ? (totalQty/totalFF) : 0;

  el('kpiSales').textContent = fmtMoney(totalSales);
  el('kpiSalesSub').textContent = `${state.days}-day total`;
  el('kpiFF').textContent   = fmtInt(totalFF);
  el('kpiConv').textContent = `Conv ${(conv*100).toFixed(1)}%`;
  el('kpiQty').textContent  = fmtInt(totalQty);
  el('kpiUPT').textContent  = `UPT ${upt.toFixed(2)}`;
  el('kpiASP').textContent  = `₹ ${Math.round(asp).toLocaleString('en-IN')}`;
  el('kpiATV').textContent  = `ATV ₹ ${Math.round(atv).toLocaleString('en-IN')}`;

  // sparkline data (last N small points)
  const byDay = groupBy(rows, r=>r.date.toISOString().slice(0,10));
  const days = [...byDay.keys()].sort();
  const sSeries = days.map(d => byDay.get(d).reduce((s,r)=>s+r.sales,0));
  const fSeries = days.map(d => byDay.get(d).reduce((s,r)=>s+r.footfall,0));
  const qSeries = days.map(d => byDay.get(d).reduce((s,r)=>s+r.qty,0));
  const aSeries = days.map(d => {
    const g=byDay.get(d); const qs=g.reduce((s,r)=>s+r.qty,0); const ss=g.reduce((s,r)=>s+r.sales,0); 
    return qs? ss/qs : 0;
  });

  const sparkOpt = (ctx, data, color='#22d3ee') => ({
    type:'line',
    data:{ labels:data.map((_,i)=>i+1), datasets:[{ data, borderColor:color, pointRadius:0, tension:.35, fill:true,
      backgroundColor:ctx=> {
        const {ctx:c, chart} = ctx; const g=c.createLinearGradient(0,0,0,chart.height);
        g.addColorStop(0, color+'b3'); g.addColorStop(1, color+'00'); return g;
      }}]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{x:{display:false}, y:{display:false}}, plugins:{legend:{display:false}, tooltip:{enabled:false}}}
  });

  // destroy/create
  for(const [id,series,color] of [['sSpark',sSeries,'#22d3ee'],['fSpark',fSeries,'#7c3aed'],['qSpark',qSeries,'#f43f5e'],['aSpark',aSeries,'#10b981']]){
    sparkCharts[id]?.destroy?.();
    const ctx = document.getElementById(id).getContext('2d');
    sparkCharts[id] = new Chart(ctx, sparkOpt(ctx, series, color));
  }
}

/* ---------- Big charts ---------- */
let lineChart, barChart, mixChart;

function gradient(ctx, colors){
  const g = ctx.createLinearGradient(0,0,0,ctx.canvas.height||300);
  colors.forEach(([stop,col])=>g.addColorStop(stop,col));
  return g;
}

function renderLine(){
  const rows = filterData().sort(byDateAsc);
  const byDay = groupBy(rows, r=>r.date.toISOString().slice(0,10));
  const labels = [...byDay.keys()].sort();
  const series = labels.map(d => byDay.get(d).reduce((s,r)=>s+r.sales,0));

  const el = document.getElementById('salesLine').getContext('2d');
  lineChart?.destroy?.();
  lineChart = new Chart(el, {
    type:'line',
    data:{ labels, datasets:[{
      label:'Sales',
      data: series,
      borderColor: '#22d3ee',
      borderWidth:2,
      fill:true,
      tension:.35,
      pointRadius:0,
      backgroundColor: (ctx)=>gradient(ctx.chart.ctx, [[0,'#22d3eebb'],[1,'#22d3ee00']])
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{
        x:{ ticks:{ color:'#bcd', maxRotation:0, autoSkip:true }, grid:{ color:'rgba(255,255,255,.08)' } },
        y:{ ticks:{ color:'#bcd', callback: v => '₹ '+Number(v).toLocaleString('en-IN') }, grid:{ color:'rgba(255,255,255,.08)' } }
      },
      plugins:{
        legend:{display:false},
        tooltip:{ callbacks:{ label:(ctx)=> '₹ '+Math.round(ctx.parsed.y).toLocaleString('en-IN') } }
      }
    }
  });

  const scope = (state.mall==='All'?'All malls':state.mall) + ' • ' + (state.rep==='All'?'All reps':state.rep);
  document.getElementById('scopeBadge').textContent = scope;
}

function renderBars(){
  // Always compare malls over last 30 days
  const start = new Date(today); start.setDate(today.getDate()-29);
  const rows = data.filter(r=>r.date>=start);
  const mallAgg = Array.from(groupBy(rows, r=>r.mall), ([mall, g]) => ({ mall, sales: g.reduce((s,r)=>s+r.sales,0)}))
                       .sort((a,b)=>b.sales-a.sales).slice(0,12);

  const labels = mallAgg.map(x=>x.mall);
  const values = mallAgg.map(x=>x.sales);

  const ctx = document.getElementById('mallBars').getContext('2d');
  barChart?.destroy?.();
  barChart = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{
      label:'Sales',
      data:values,
      backgroundColor: (c)=>gradient(c.chart.ctx, [[0,'#7c3aed'],[1,'#22d3ee']]),
      borderRadius:10
    }]},
    options:{
      indexAxis:'y',
      responsive:true, maintainAspectRatio:false,
      scales:{
        x:{ ticks:{ color:'#bcd', callback:v=>'₹ '+Number(v).toLocaleString('en-IN') }, grid:{ color:'rgba(255,255,255,.08)' } },
        y:{ ticks:{ color:'#bcd' }, grid:{ display:false } }
      },
      plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label:(ctx)=>'₹ '+Math.round(ctx.parsed.x).toLocaleString('en-IN') } } }
    }
  });
}

function renderMix(){
  const rows = filterData().sort(byDateAsc);
  const byDay = groupBy(rows, r=>r.date.toISOString().slice(0,10));
  const labels = [...byDay.keys()].sort();
  const qty  = labels.map(d => byDay.get(d).reduce((s,r)=>s+r.qty,0));
  const bills= labels.map(d => byDay.get(d).reduce((s,r)=>s+r.bills,0));
  const conv = labels.map(d => {
    const g=byDay.get(d); const ff=g.reduce((s,r)=>s+r.footfall,0); const q=g.reduce((s,r)=>s+r.qty,0);
    return ff? (q/ff)*100 : 0;
  });

  const ctx = document.getElementById('mixChart').getContext('2d');
  mixChart?.destroy?.();
  mixChart = new Chart(ctx, {
    data:{
      labels,
      datasets:[
        { type:'bar', label:'Qty', data:qty, yAxisID:'y', backgroundColor:'#f43f5eaa', borderRadius:8 },
        { type:'line', label:'Bills', data:bills, yAxisID:'y', borderColor:'#7c3aed', backgroundColor:'#7c3aed33', tension:.35, pointRadius:0, fill:true },
        { type:'line', label:'Conv %', data:conv, yAxisID:'y1', borderColor:'#10b981', tension:.35, pointRadius:0 }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      scales:{
        y:{ position:'left', ticks:{ color:'#bcd' }, grid:{ color:'rgba(255,255,255,.08)' } },
        y1:{ position:'right', ticks:{ color:'#bcd', callback:v=>v+'%' }, grid:{ drawOnChartArea:false } },
        x:{ ticks:{ color:'#bcd', maxRotation:0 }, grid:{ color:'rgba(255,255,255,.06)' } }
      },
      plugins:{ legend:{ labels:{ color:'#cfe' } } }
    }
  });
}

/* ---------- Leaderboard ---------- */
function renderTable(){
  const rows = filterData();
  const byRep = Array.from(groupBy(rows, r=>r.rep),
                  ([rep, g])=>({rep,
                    sales:g.reduce((s,r)=>s+r.sales,0),
                    qty:g.reduce((s,r)=>s+r.qty,0),
                    bills:g.reduce((s,r)=>s+r.bills,0)}))
                .sort((a,b)=>b.sales-a.sales);

  const tbody = document.querySelector('#repTable tbody');
  tbody.innerHTML = byRep.map(r=>{
    const asp = r.qty ? r.sales/r.qty : 0;
    const upt = r.bills ? r.qty/r.bills : 0;
    return `<tr>
      <td>${r.rep}</td>
      <td>${fmtMoney(r.sales)}</td>
      <td>${fmtInt(r.qty)}</td>
      <td>${fmtInt(r.bills)}</td>
      <td>₹ ${Math.round(asp).toLocaleString('en-IN')}</td>
      <td>${upt.toFixed(2)}</td>
    </tr>`;
  }).join('');
}

/* ---------- Render all ---------- */
function renderAll(){
  const scope = (state.mall==='All'?'All malls':state.mall) + ' • ' + (state.rep==='All'?'All reps':state.rep);
  document.getElementById('scopeBadge').textContent = scope;
  renderKPIs(); renderLine(); renderBars(); renderMix(); renderTable();
}

/* ---------- Boot ---------- */
initFilters();
renderAll();
window.addEventListener('resize', ()=>{ renderLine(); renderBars(); renderMix(); });
</script>
</body>
</html>
