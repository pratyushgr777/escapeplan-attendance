<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>EscapePlan Attendance Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ====== Bright, techy mobile-first UI ====== -->
<style>
  :root{
    /* Neon tech palette */
    --bg1:#050815;
    --bg2:#0b1024;
    --panel:rgba(255,255,255,.08);
    --stroke:rgba(255,255,255,.12);
    --text:#eaf2ff;
    --muted:#b3c0d9;

    --accent:#22d3ee;   /* cyan */
    --accent2:#7c3aed;  /* violet */
    --accent3:#f43f5e;  /* pink */

    --ok:#16a34a;     /* green */
    --warn:#f59e0b;   /* amber */
    --bad:#ef4444;    /* red */

    --radius:16px;
    --shadow:0 16px 50px rgba(7, 9, 26, .65);
    --inset:inset 0 0 0 1px rgba(255,255,255,.08);
    --glass:backdrop-filter: blur(12px) saturate(140%);
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; color:var(--text); font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    background:
      radial-gradient(1200px 700px at -10% -10%, rgba(34,211,238,.25), transparent 60%),
      radial-gradient(1200px 700px at 110% 10%, rgba(124,58,237,.20), transparent 60%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
    display:flex; flex-direction:column;
  }

  /* Header */
  .appbar{
    position:sticky; top:0; z-index:40; border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(5,8,21,.85), rgba(5,8,21,.65));
    --glass;     
  }
  .appbar-inner{
    max-width:880px; margin:0 auto; padding:14px 16px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  .brand{
    display:flex; align-items:center; gap:12px; font-weight:900; letter-spacing:.3px;
    font-size:18px;
  }
  .logo{
    width:28px; height:28px; border-radius:50%;
    background:
      radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.55) 35%, transparent 36%),
      conic-gradient(from 180deg, var(--accent), var(--accent2), var(--accent3), var(--accent));
    box-shadow:0 0 22px rgba(124,58,237,.55), 0 0 28px rgba(34,211,238,.45);
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px; font-size:12px;
    color:#e2f6ff; background:linear-gradient(90deg, rgba(34,211,238,.15), rgba(124,58,237,.15));
    border:1px solid var(--stroke);
  }

  /* Layout */
  .wrap{ max-width:880px; width:100%; margin:18px auto 28px; padding:0 16px; display:grid; gap:16px }
  .panel{
    border-radius:var(--radius);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid var(--stroke); box-shadow:var(--shadow); overflow:hidden;
  }
  .h{
    padding:12px 16px; font-weight:900; letter-spacing:.2px; border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  }
  .b{ padding:14px; }

  /* Form */
  label{ display:block; font-size:12px; color:var(--muted); margin:6px 2px }
  .grid{ display:grid; gap:12px }
  @media (min-width:720px){ .grid-3{ grid-template-columns: 1fr 1fr 1fr } }

  select, input[type="file"]{
    width:100%; padding:12px 14px; border-radius:12px;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(5,8,21,.85), rgba(5,8,21,.75));
    color:#eaf2ff; font-size:16px; box-shadow:var(--inset);
  }
  select:focus{ outline:none; box-shadow:0 0 0 3px rgba(34,211,238,.22) }

  /* Buttons */
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .btn{
    appearance:none; cursor:pointer;
    border:1px solid var(--stroke); border-radius:12px; padding:12px 16px; font-size:15px; font-weight:700;
    color:#0b1024; background:linear-gradient(90deg, #22d3ee, #7c3aed);
    box-shadow: 0 8px 24px rgba(124,58,237,.35), inset 0 0 0 1px rgba(255,255,255,.25);
  }
  .btn.alt{
    color:#eaf2ff; background:linear-gradient(90deg, rgba(124,58,237,.25), rgba(34,211,238,.25));
  }
  .btn:active{ transform:translateY(1px) }

  /* Badges / status */
  .badge{
    font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke);
    background:rgba(255,255,255,.06); color:#eaf2ff;
  }
  .ok   { color:#d1fae5; border-color:rgba(22,163,74,.35); background:linear-gradient(90deg, rgba(16,185,129,.15), rgba(34,197,94,.10)); }
  .warn { color:#ffefcc; border-color:rgba(245,158,11,.40); background:linear-gradient(90deg, rgba(245,158,11,.18), rgba(251,191,36,.12)); }
  .bad  { color:#ffd6d6; border-color:rgba(239,68,68,.45); background:linear-gradient(90deg, rgba(239,68,68,.18), rgba(244,63,94,.12)); }

  .preview{ width:100%; max-height:300px; object-fit:cover; border-radius:14px; border:1px solid var(--stroke); box-shadow:var(--inset); }

  .muted{ color:var(--muted); font-size:12px }
  .footer{ text-align:center; color:var(--muted); font-size:12px; padding:14px 0 28px }
</style>
</head>
<body>

<!-- Header -->
<header class="appbar">
  <div class="appbar-inner">
    <div class="brand"><div class="logo"></div> EscapePlan Attendance Tracker</div>
    <div class="pill">GPS + Photo • Mobile</div>
  </div>
</header>

<main class="wrap">

  <!-- Filters -->
  <section class="panel">
    <div class="h">Identify Yourself</div>
    <div class="b">
      <div class="grid grid-3">
        <div>
          <label>City</label>
          <select id="city"><option value="">Select City</option></select>
        </div>
        <div>
          <label>Mall</label>
          <select id="mall"><option value="">Select Mall</option></select>
        </div>
        <div>
          <label>Your Name</label>
          <select id="rep"><option value="">Select Your Name</option></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <span id="storeIdBadge" class="badge" style="display:none"></span>
        <span id="refBadge" class="badge" style="display:none"></span>
      </div>

      <div class="muted" style="margin-top:8px">Choose your city, mall and name. Then allow location & camera.</div>
    </div>
  </section>

  <!-- Location -->
  <section class="panel">
    <div class="h">Location</div>
    <div class="b">
      <div class="row">
        <button id="locBtn" class="btn">Use My Location</button>
        <span id="locStatus" class="badge">Waiting…</span>
      </div>
      <div class="row" style="margin-top:10px">
        <span>Distance to store:</span>
        <strong id="distance" style="font-size:18px; letter-spacing:.3px">— m</strong>
        <span id="proximity" class="badge" style="display:none"></span>
      </div>
    </div>
  </section>

  <!-- Photo -->
  <section class="panel">
    <div class="h">Photo</div>
    <div class="b">
      <input id="photo" type="file" accept="image/*" capture="environment">
      <div style="margin-top:10px">
        <img id="preview" class="preview" style="display:none" alt="Preview">
      </div>
    </div>
  </section>

  <!-- Submit -->
  <section class="panel">
    <div class="h">Submit</div>
    <div class="b">
      <div class="row">
        <button id="submitBtn" class="btn">Submit Attendance</button>
        <button id="resetBtn" class="btn alt">Reset</button>
        <span id="submitStatus" class="badge">Not submitted</span>
      </div>
      <div class="muted" style="margin-top:8px">We save a timestamp (IST), your GPS, distance status, and photo in today's tab of the master sheet.</div>
    </div>
  </section>

  <div class="footer">Privacy: location & camera are used only for attendance capture.</div>
</main>

<script>
/** ====== CONFIG (your real IDs & URL already filled) ====== */
const ROSTER_SHEET_ID = '13od8p_pcVQsMGHVqhoI-bOrW3xDeOKNeM4rf0uc8PX4';
const ROSTER_TAB_NAME = 'Roster';
const GAS_WEBAPP_URL  = 'https://script.google.com/macros/s/AKfycbzUDKjO8sHe9tLB52OKFvnSyQxJWNARdaGDzWgvxd_P8p6_tp6a2Z-jG5ev8KTKsCTd/exec';

/* Use OpenSheet to read the roster tab (keep backticks) */
const ROSTER_URL = `https://opensheet.vercel.app/${ROSTER_SHEET_ID}/${encodeURIComponent(ROSTER_TAB_NAME)}`;

/** ====== STATE ====== */
let ROSTER = [];
let selected = { city:'', mall:'', rep:'', storeId:'', refLat:null, refLon:null };
let userLat = null, userLon = null;
let watchId = null;
let photoBase64 = '';

/** ====== HELPERS ====== */
const $ = id => document.getElementById(id);
const t = v => v==null ? '' : String(v).trim();
const num = v => { const x = parseFloat(String(v).replace(/,/g,'')); return Number.isFinite(x)?x:NaN; };
function uniq(arr){ return Array.from(new Set(arr.filter(x => t(x) !== ''))); }
function haversineMeters(lat1, lon1, lat2, lon2){
  const toRad = d => d * Math.PI / 180, R = 6371000;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}
function setProximityBadge(m){
  const el = $("proximity");
  el.style.display = "inline-flex";
  if (m < 100){ el.textContent = "OK (<100m)"; el.className = "badge ok"; }
  else if (m <= 250){ el.textContent = "Check (100–250m)"; el.className = "badge warn"; }
  else { el.textContent = "Not captured (>250m)"; el.className = "badge bad"; }
}

/** ====== LOAD ROSTER ====== */
async function loadRoster(){
  try{
    const res = await fetch(ROSTER_URL);
    ROSTER = await res.json();
    const cities = uniq(ROSTER.map(r => t(r['City'])));
    $("city").innerHTML = `<option value="">Select City</option>` + cities.sort().map(c=>`<option value="${c}">${c}</option>`).join('');
  }catch(e){
    $("city").innerHTML = `<option value="">Failed to load roster</option>`;
  }
}
$("city").addEventListener("change", ()=>{
  selected.city = $("city").value;
  const malls = uniq(ROSTER.filter(r => t(r['City'])===t(selected.city)).map(r => t(r['Mall'])));
  $("mall").innerHTML = `<option value="">Select Mall</option>` + malls.sort().map(m=>`<option value="${m}">${m}</option>`).join('');
  $("rep").innerHTML = `<option value="">Select Your Name</option>`;
  $("storeIdBadge").style.display = "none"; $("refBadge").style.display = "none";
});
$("mall").addEventListener("change", ()=>{
  selected.mall = $("mall").value;
  const reps = uniq(ROSTER.filter(r => t(r['City'])===t(selected.city) && t(r['Mall'])===t(selected.mall)).map(r => t(r['Salesperson'])));
  $("rep").innerHTML = `<option value="">Select Your Name</option>` + reps.sort().map(r=>`<option value="${r}">${r}</option>`).join('');
  $("storeIdBadge").style.display = "none"; $("refBadge").style.display = "none";
});
$("rep").addEventListener("change", ()=>{
  selected.rep = $("rep").value;
  const row = ROSTER.find(r => t(r['City'])===t(selected.city) && t(r['Mall'])===t(selected.mall) && t(r['Salesperson'])===t(selected.rep)) || {};
  selected.storeId = t(row['Store ID']);
  selected.refLat = num(row['Ref Lat']);
  selected.refLon = num(row['Ref Lon']);
  if (selected.storeId){ $("storeIdBadge").textContent = "Store ID: " + selected.storeId; $("storeIdBadge").style.display = "inline-flex"; }
  if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
    $("refBadge").textContent = `Ref: ${selected.refLat.toFixed(5)}, ${selected.refLon.toFixed(5)}`;
    $("refBadge").style.display = "inline-flex";
  }
});

/** ====== GEO ====== */
$("locBtn").addEventListener("click", ()=>{
  if (!navigator.geolocation){ $("locStatus").textContent = "Geolocation not supported"; return; }
  $("locStatus").textContent = "Requesting permission…";
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
  watchId = navigator.geolocation.watchPosition(
    pos=>{
      userLat = pos.coords.latitude; userLon = pos.coords.longitude;
      $("locStatus").textContent = `Live: ${userLat.toFixed(5)}, ${userLon.toFixed(5)} (±${Math.round(pos.coords.accuracy)}m)`;
      if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
        const m = haversineMeters(userLat, userLon, selected.refLat, selected.refLon);
        $("distance").textContent = `${m} m`; setProximityBadge(m);
      } else {
        $("distance").textContent = "— m";
      }
    },
    err=>{ $("locStatus").textContent = "Location denied or unavailable"; },
    { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
  );
});

/** ====== PHOTO (compress & preview) ====== */
$("photo").addEventListener("change", (e)=>{
  const f = e.target.files && e.target.files[0]; if (!f) return;
  const img = new Image();
  img.onload = ()=>{
    const MAX = 1280, s = Math.min(1, MAX/img.width, MAX/img.height);
    const w = Math.round(img.width * s), h = Math.round(img.height * s);
    const canvas = document.createElement("canvas"); canvas.width=w; canvas.height=h;
    const ctx = canvas.getContext("2d"); ctx.drawImage(img, 0, 0, w, h);
    photoBase64 = canvas.toDataURL("image/jpeg", 0.82);
    $("preview").src = photoBase64; $("preview").style.display = "block";
  };
  const reader = new FileReader(); reader.onload = ()=> img.src = reader.result; reader.readAsDataURL(f);
});

/** ====== SUBMIT ====== */
$("submitBtn").addEventListener("click", async ()=>{
  if (!selected.city || !selected.mall || !selected.rep){ $("submitStatus").textContent = "Select City, Mall & Your Name"; return; }
  if (userLat==null || userLon==null){ $("submitStatus").textContent = "Tap 'Use My Location' first"; return; }
  if (!photoBase64){ $("submitStatus").textContent = "Please capture a photo"; return; }

  $("submitStatus").textContent = "Submitting…";

  const payload = {
    city: selected.city, mall: selected.mall, salesperson: selected.rep,
    storeId: selected.storeId || '', userLat, userLon, photoBase64
  };

  try{
    const res = await fetch(GAS_WEBAPP_URL, {
      method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8}, body: JSON.stringify(payload)
    });
    const text = await res.text();
let data;
try { data = JSON.parse(text); }
catch { throw new Error('Server replied, but not JSON: ' + text.slice(0,120)); }

    const data = await res.json();
    if (data.ok){
      $("submitStatus").textContent = `Done ✓  ${data.status} • ${data.distanceMeters} m • ${data.receiptId}`;
      if (typeof data.distanceMeters === "number") setProximityBadge(data.distanceMeters);
    } else {
      $("submitStatus").textContent = "Error: " + (data.error || "Unknown");
    }
  }catch(e){
    $("submitStatus").textContent = "Network error";
  }
});

/** Reset form (handy while testing) */
$("resetBtn").addEventListener("click", ()=>{
  ["city","mall","rep"].forEach(id => $(id).selectedIndex = 0);
  selected = { city:'', mall:'', rep:'', storeId:'', refLat:null, refLon:null };
  userLat = userLon = null; photoBase64 = '';
  $("preview").style.display = "none";
  $("storeIdBadge").style.display = "none"; $("refBadge").style.display = "none";
  $("locStatus").textContent = "Waiting…"; $("distance").textContent = "— m";
  $("proximity").style.display = "none";
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId = null; }
});

/** Boot */
loadRoster();
</script>
</body>
</html>
