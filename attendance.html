<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>EscapePlan Attendance Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Bright, techy mobile-first UI -->
<style>
  :root{
    --bg1:#050815; --bg2:#0b1024; --stroke:rgba(255,255,255,.14);
    --text:#eaf2ff; --muted:#b3c0d9;
    --accent:#22d3ee; --violet:#7c3aed; --pink:#f43f5e;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --radius:16px; --shadow:0 16px 48px rgba(7,9,26,.6);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background:
      radial-gradient(1000px 600px at -10% -10%, rgba(34,211,238,.25), transparent 55%),
      radial-gradient(1000px 600px at 110% 10%, rgba(124,58,237,.20), transparent 55%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
    display:flex; flex-direction:column;
  }
  .appbar{position:sticky;top:0;z-index:40;border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(5,8,21,.85), rgba(5,8,21,.65))}
  .appbar-inner{max-width:880px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .logo{width:26px;height:26px;border-radius:50%;
    background:conic-gradient(from 180deg, var(--accent), var(--violet), var(--pink), var(--accent));
    box-shadow:0 0 20px rgba(34,211,238,.45),0 0 24px rgba(124,58,237,.4)}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);
    background:linear-gradient(90deg, rgba(34,211,238,.15), rgba(124,58,237,.15))}
  .wrap{max-width:880px;width:100%;margin:18px auto 28px;padding:0 16px;display:grid;gap:16px}
  .panel{border-radius:var(--radius);border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));box-shadow:var(--shadow);overflow:hidden}
  .h{padding:12px 16px;font-weight:900;border-bottom:1px solid var(--stroke)}
  .b{padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 2px}
  .grid{display:grid;gap:12px}
  @media(min-width:720px){.grid-3{grid-template-columns:1fr 1fr 1fr}}
  select,input[type="password"],input[type="file"]{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(5,8,21,.85), rgba(5,8,21,.75));color:var(--text);font-size:16px
  }
  select:focus,input:focus{outline:none;box-shadow:0 0 0 3px rgba(34,211,238,.22)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid var(--stroke);border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
  .btn.primary{color:#0b1024;background:linear-gradient(90deg,#22d3ee,#7c3aed)}
  .btn.alt{color:#eaf2ff;background:linear-gradient(90deg,rgba(124,58,237,.25),rgba(34,211,238,.25))}
  .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06)}
  .ok{color:#d1fae5;border-color:rgba(22,163,74,.35);background:linear-gradient(90deg,rgba(16,185,129,.15),rgba(34,197,94,.1))}
  .warn{color:#ffefcc;border-color:rgba(245,158,11,.4);background:linear-gradient(90deg,rgba(245,158,11,.18),rgba(251,191,36,.12))}
  .bad{color:#ffd6d6;border-color:rgba(239,68,68,.45);background:linear-gradient(90deg,rgba(239,68,68,.18),rgba(244,63,94,.12))}
  .preview{width:100%;max-height:300px;object-fit:cover;border-radius:14px;border:1px solid var(--stroke)}
  .muted{color:var(--muted);font-size:12px}
  .footer{text-align:center;color:var(--muted);font-size:12px;padding:14px 0 28px}
</style>
<!-- On-device face verify -->
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/human/dist/human.js"></script>
</head>
<body>
<header class="appbar">
  <div class="appbar-inner">
    <div class="brand"><div class="logo"></div>EscapePlan Attendance Tracker</div>
    <div class="pill">GPS + Watermark + Face Verify</div>
  </div>
</header>

<main class="wrap">

  <section class="panel">
    <div class="h">Identify Yourself</div>
    <div class="b">
      <div class="grid grid-3">
        <div>
          <label>City</label>
          <select id="city"><option value="">Select City</option></select>
        </div>
        <div>
          <label>Mall</label>
          <select id="mall"><option value="">Select Mall</option></select>
        </div>
        <div>
          <label>Your Name</label>
          <select id="rep"><option value="">Select Your Name</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <span id="storeIdBadge" class="badge" style="display:none"></span>
        <span id="refBadge" class="badge" style="display:none"></span>
        <span id="faceStatus" class="badge" style="display:none"></span>
      </div>
      <div class="muted" style="margin-top:8px">Choose your city, mall and name. Then allow location & camera.</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Location</div>
    <div class="b">
      <div class="row">
        <button id="locBtn" class="btn primary">Use My Location</button>
        <span id="locStatus" class="badge">Waiting…</span>
      </div>
      <div class="row" style="margin-top:10px">
        <span>Distance to store:</span>
        <strong id="distance" style="font-size:18px;letter-spacing:.3px">— m</strong>
        <span id="proximity" class="badge" style="display:none"></span>
      </div>
      <div class="muted" id="addrLine" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Photo</div>
    <div class="b">
      <input id="photo" type="file" accept="image/*" capture="environment">
      <div style="margin-top:10px">
        <img id="preview" class="preview" style="display:none" alt="Preview">
      </div>
      <div class="muted" style="margin-top:6px">The photo is watermarked with name, date/time (IST), GPS & address.</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Submit</div>
    <div class="b">
      <div class="row">
        <button id="submitBtn" class="btn primary">Submit Attendance</button>
        <button id="resetBtn" class="btn alt">Reset</button>
        <span id="submitStatus" class="badge">Not submitted</span>
      </div>
      <div class="muted" style="margin-top:8px">We save a server timestamp (IST), plus your GPS, status, address, face score & photo URL in today's tab.</div>
    </div>
  </section>

  <div class="footer">Privacy: location & camera used only for attendance capture.</div>
</main>

<script>
/** ==== CONFIG (your values) ==== */
const ROSTER_SHEET_ID = '13od8p_pcVQsMGHVqhoI-bOrW3xDeOKNeM4rf0uc8PX4';
const ROSTER_TAB_NAME = 'Roster';
const GAS_WEBAPP_URL  = 'https://script.google.com/macros/s/AKfycbzUDKjO8sHe9tLB52OKFvnSyQxJWNARdaGDzWgvxd_P8p6_tp6a2Z-jG5ev8KTKsCTd/exec';
const ROSTER_URL = `https://opensheet.vercel.app/${ROSTER_SHEET_ID}/${encodeURIComponent(ROSTER_TAB_NAME)}`;

/** ==== STATE ==== */
let ROSTER = [];
let selected = { city:'', mall:'', rep:'', storeId:'', refLat:null, refLon:null, refPhotoUrl:'' };
let userLat = null, userLon = null, lastAccuracy = null;
let watchId = null;
let photoBase64 = '';
let addressText = '';  // reverse-geocoded
let clientTsIST = '';  // client-side IST (for watermark)
let faceScore = null, faceVerified = false;

// Human face-lib
const human = new Human({
  modelBasePath: 'https://vladmandic.github.io/human/models',
  cacheSensitivity: 0,
  face: { enabled:true, detector:{ maxDetected:1 }, mesh:false, iris:false, description:{ enabled:true } }
});
human.load().then(()=>human.warmup());

/** ==== HELPERS ==== */
const $ = id => document.getElementById(id);
const t = v => v==null ? '' : String(v).trim();
const num = v => { const x = parseFloat(String(v).replace(/,/g,'')); return Number.isFinite(x)?x:NaN; };
function uniq(a){ return Array.from(new Set(a.filter(x => t(x) !== ''))); }
function haversineMeters(lat1, lon1, lat2, lon2){
  const toRad = d=>d*Math.PI/180, R=6371000;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}
function setProximityBadge(m){
  const el = $("proximity"); el.style.display="inline-flex";
  if (m < 100){ el.textContent = "OK (<100m)"; el.className = "badge ok"; }
  else if (m <= 250){ el.textContent = "Check (100–250m)"; el.className = "badge warn"; }
  else { el.textContent = "Not captured (>250m)"; el.className = "badge bad"; }
}
function nowIST(){ return new Date().toLocaleString('en-IN',{ timeZone:'Asia/Kolkata', hour12:false }); }
async function reverseGeocode(lat, lon){
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=16&addressdetails=1`;
    const res = await fetch(url, { headers:{ 'Accept':'application/json' }});
    const j = await res.json();
    return j.display_name || '';
  }catch{ return ''; }
}
function cosineSimilarity(a,b){
  let dot=0,na=0,nb=0;
  for (let i=0;i<a.length && i<b.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; }
  return dot / (Math.sqrt(na)*Math.sqrt(nb));
}
function setFaceBadge(){
  const el = $("faceStatus"); el.style.display = "inline-flex";
  if (faceScore==null){ el.textContent = "Face: not detected"; el.className="badge warn"; return; }
  el.textContent = faceVerified ? `Face: Verified (${(faceScore*100|0)/100})` : `Face: Not match (${(faceScore*100|0)/100})`;
  el.className = faceVerified ? "badge ok" : "badge bad";
}

/** ==== LOAD ROSTER ==== */
async function loadRoster(){
  const res = await fetch(ROSTER_URL);
  ROSTER = await res.json();
  const cities = uniq(ROSTER.map(r=>t(r['City'])));
  $("city").innerHTML = `<option value="">Select City</option>` + cities.sort().map(c=>`<option value="${c}">${c}</option>`).join('');
}
$("city").addEventListener("change", ()=>{
  selected.city = $("city").value;
  const malls = uniq(ROSTER.filter(r=>t(r['City'])===t(selected.city)).map(r=>t(r['Mall'])));
  $("mall").innerHTML = `<option value="">Select Mall</option>` + malls.sort().map(m=>`<option value="${m}">${m}</option>`).join('');
  $("rep").innerHTML = `<option value="">Select Your Name</option>`;
  ["storeIdBadge","refBadge","faceStatus"].forEach(id => $(id).style.display="none");
});
$("mall").addEventListener("change", ()=>{
  selected.mall = $("mall").value;
  const reps = uniq(ROSTER.filter(r=>t(r['City'])===t(selected.city) && t(r['Mall'])===t(selected.mall)).map(r=>t(r['Salesperson'])));
  $("rep").innerHTML = `<option value="">Select Your Name</option>` + reps.sort().map(r=>`<option value="${r}">${r}</option>`).join('');
  ["storeIdBadge","refBadge","faceStatus"].forEach(id => $(id).style.display="none");
});
$("rep").addEventListener("change", ()=>{
  selected.rep = $("rep").value;
  const row = ROSTER.find(r => t(r['City'])===t(selected.city) && t(r['Mall'])===t(selected.mall) && t(r['Salesperson'])===t(selected.rep)) || {};
  selected.storeId = t(row['Store ID']);
  selected.refLat = num(row['Ref Lat']); selected.refLon = num(row['Ref Lon']);
  selected.refPhotoUrl = t(row['Ref Photo URL']);
  if (selected.storeId){ $("storeIdBadge").textContent = "Store ID: " + selected.storeId; $("storeIdBadge").style.display="inline-flex"; }
  if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
    $("refBadge").textContent = `Ref: ${selected.refLat.toFixed(5)}, ${selected.refLon.toFixed(5)}`;
    $("refBadge").style.display="inline-flex";
  }
});

/** ==== GEO ==== */
$("locBtn").addEventListener("click", ()=>{
  if (!navigator.geolocation){ $("locStatus").textContent = "Geolocation not supported"; return; }
  $("locStatus").textContent = "Requesting permission…";
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  watchId = navigator.geolocation.watchPosition(
    async pos=>{
      userLat = pos.coords.latitude; userLon = pos.coords.longitude;
      lastAccuracy = Math.round(pos.coords.accuracy||0);
      clientTsIST = nowIST();
      $("locStatus").textContent = `Live: ${userLat.toFixed(5)}, ${userLon.toFixed(5)} (±${lastAccuracy}m)`;
      if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
        const m = haversineMeters(userLat,userLon,selected.refLat,selected.refLon);
        $("distance").textContent = `${m} m`; setProximityBadge(m);
      }
      // reverse geocode (once per session or when coords change a lot)
      addressText = await reverseGeocode(userLat, userLon);
      $("addrLine").textContent = addressText ? `Address: ${addressText}` : '';
    },
    err=>{ $("locStatus").textContent = "Location denied or unavailable"; },
    { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
  );
});

/** ==== PHOTO (watermark + face-verify) ==== */
async function runFaceVerify(refUrl, capBase64){
  faceScore = null; faceVerified = false;
  if (!refUrl) return; // nothing to compare
  try{
    const refImg = await loadImg(refUrl);
    const capImg = await loadImg(capBase64);
    const [refDet, capDet] = await Promise.all([human.detect(refImg), human.detect(capImg)]);
    const refEmb = refDet?.face?.[0]?.embedding;
    const capEmb = capDet?.face?.[0]?.embedding;
    if (refEmb && capEmb){
      faceScore = cosineSimilarity(refEmb, capEmb);       // 0..1 (higher is more similar)
      faceVerified = faceScore >= 0.85;                   // threshold; adjust if needed
    }
  }catch(e){ /* ignore */ }
}
function loadImg(src){
  return new Promise((resolve,reject)=>{ const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>resolve(im); im.onerror=reject; im.src=src; });
}

$("photo").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = async ()=>{
    const img = new Image();
    img.onload = async ()=>{
      // Resize & draw
      const MAX = 1280, s = Math.min(1, MAX/img.width, MAX/img.height);
      const w = Math.round(img.width*s), h = Math.round(img.height*s);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      // Watermark box
      ctx.fillStyle = 'rgba(0,0,0,0.58)'; ctx.fillRect(0, h-70, w, 70);
      ctx.fillStyle = '#fff'; ctx.font = '16px system-ui, Segoe UI, Roboto, Arial';
      const ts = clientTsIST || nowIST();
      const line1 = `${selected.rep} • ${selected.city}/${selected.mall}`;
      const line2 = `${ts} • ${userLat?.toFixed(5)||'-'},${userLon?.toFixed(5)||'-'} (±${lastAccuracy||'-'}m)`;
      const line3 = (addressText||'').slice(0, 80);
      ctx.fillText(line1, 10, h-46);
      ctx.fillText(line2, 10, h-26);
      ctx.fillText(line3, 10, h-8);

      // Export
      photoBase64 = canvas.toDataURL('image/jpeg', 0.85);
      $("preview").src = photoBase64; $("preview").style.display = "block";

      // Face verify (non-blocking visual)
      $("faceStatus").style.display="inline-flex"; $("faceStatus").textContent = "Face: checking…";
      await runFaceVerify(selected.refPhotoUrl, photoBase64);
      setFaceBadge();
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(f);
});

/** ==== SUBMIT ==== */
$("submitBtn").addEventListener("click", async ()=>{
  if (!selected.city || !selected.mall || !selected.rep){ $("submitStatus").textContent = "Select City, Mall & Your Name"; return; }
  if (userLat==null || userLon==null){ $("submitStatus").textContent = "Tap 'Use My Location' first"; return; }
  if (!photoBase64){ $("submitStatus").textContent = "Please capture a photo"; return; }

  $("submitStatus").textContent = "Submitting…";

  const payload = {
    city: selected.city, mall: selected.mall, salesperson: selected.rep,
    storeId: selected.storeId || '',
    userLat, userLon, accuracy: lastAccuracy, address: addressText, clientTimestampIST: clientTsIST || nowIST(),
    faceScore, faceVerified,
    photoBase64
  };

  try{
    const res = await fetch(GAS_WEBAPP_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // avoid preflight/CORS
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch{ throw new Error('Server replied, not JSON: ' + text.slice(0,120)); }
    if (data.ok){
      $("submitStatus").textContent = `Done ✓  ${data.status} • ${data.distanceMeters} m • ${data.receiptId}`;
      if (typeof data.distanceMeters === 'number') setProximityBadge(data.distanceMeters);
    } else {
      $("submitStatus").textContent = "Error: " + (data.error || "Unknown");
    }
  }catch(e){
    $("submitStatus").textContent = "Network error";
  }
});

// Reset
$("resetBtn").addEventListener("click", ()=>{
  ["city","mall","rep"].forEach(id => $(id).selectedIndex = 0);
  selected = { city:'', mall:'', rep:'', storeId:'', refLat:null, refLon:null, refPhotoUrl:'' };
  userLat = userLon = null; lastAccuracy = null; addressText=''; clientTsIST='';
  photoBase64=''; faceScore=null; faceVerified=false;
  $("preview").style.display = "none";
  ["storeIdBadge","refBadge","faceStatus"].forEach(id => $(id).style.display="none");
  $("locStatus").textContent = "Waiting…"; $("distance").textContent = "— m"; $("proximity").style.display="none"; $("addrLine").textContent='';
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
});

/** Boot */
loadRoster();
</script>
</body>
</html>
