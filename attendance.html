<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>EscapePlan Attendance Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#0b1024">
<style>
  :root{
    --bg1:#050815; --bg2:#0b1024; --stroke:rgba(255,255,255,.14);
    --text:#eaf2ff; --muted:#b3c0d9;
    --accent:#22d3ee; --violet:#7c3aed;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --radius:16px; --shadow:0 16px 48px rgba(7,9,26,.6)
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background:
      radial-gradient(1000px 600px at -10% -10%, rgba(34,211,238,.25), transparent 55%),
      radial-gradient(1000px 600px at 110% 10%, rgba(124,58,237,.20), transparent 55%),
      linear-gradient(160deg, var(--bg1), var(--bg2));
    display:flex; flex-direction:column;
  }
  .appbar{position:sticky;top:0;z-index:40;border-bottom:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(5,8,21,.85), rgba(5,8,21,.65))}
  .appbar-inner{max-width:880px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .logo{width:26px;height:26px;border-radius:50%;
    background:conic-gradient(from 180deg, var(--accent), var(--violet), #f43f5e, var(--accent))}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);
    background:linear-gradient(90deg, rgba(34,211,238,.15), rgba(124,58,237,.15)); cursor:pointer}
  .wrap{max-width:880px;width:100%;margin:18px auto 28px;padding:0 16px;display:grid;gap:16px}
  .panel{border-radius:var(--radius);border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));box-shadow:var(--shadow);overflow:hidden}
  .h{padding:12px 16px;font-weight:900;border-bottom:1px solid var(--stroke)}
  .b{padding:14px}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 2px}
  .grid{display:grid;gap:12px}
  @media(min-width:720px){.grid-3{grid-template-columns:1fr 1fr 1fr}}
  select,input[type="file"]{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(5,8,21,.85), rgba(5,8,21,.75));color:var(--text);font-size:16px
  }
  select:focus,input:focus{outline:none;box-shadow:0 0 0 3px rgba(34,211,238,.22)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .seg{display:inline-flex;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
  .seg button{padding:10px 14px;background:transparent;color:var(--text);border:none}
  .seg button.active{background:linear-gradient(90deg,#22d3ee,#7c3aed);color:#0b1024;font-weight:800}
  .btn{border:1px solid var(--stroke);border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;transition:.2s}
  .btn.primary{color:#0b1024;background:linear-gradient(90deg,#22d3ee,#7c3aed)}
  .btn.alt{color:#eaf2ff;background:linear-gradient(90deg,rgba(124,58,237,.25),rgba(34,211,238,.25))}
  .btn[disabled]{opacity:.55; cursor:not-allowed; filter:saturate(.5)}
  .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06)}
  .ok{color:#d1fae5;border-color:rgba(22,163,74,.35);background:linear-gradient(90deg,rgba(16,185,129,.15),rgba(34,197,94,.1))}
  .warn{color:#ffefcc;border-color:rgba(245,158,11,.35);background:linear-gradient(90deg,rgba(245,158,11,.18),rgba(251,191,36,.12))}
  .bad{color:#ffd6d6;border-color:rgba(239,68,68,.4);background:linear-gradient(90deg,rgba(239,68,68,.20),rgba(239,68,68,.12))}
  .preview{width:100%;max-height:300px;object-fit:cover;border-radius:14px;border:1px solid var(--stroke)}
  .muted{color:var(--muted);font-size:12px}
  .footer{text-align:center;color:var(--muted);font-size:12px;padding:14px 0 28px}
  .banner{display:none;margin-top:12px;border-radius:14px;padding:14px;border:1px solid var(--stroke)}
  .banner h3{margin:0 0 6px 0;font-size:18px}
  .banner p{margin:0;color:var(--muted);font-size:13px}
  .banner.ok{border-color:rgba(22,163,74,.35);background:linear-gradient(180deg, rgba(16,185,129,.16), rgba(16,185,129,.10))}
  .banner.warn{border-color:rgba(245,158,11,.35);background:linear-gradient(180deg, rgba(245,158,11,.18), rgba(251,191,36,.10))}
  .banner.bad{border-color:rgba(239,68,68,.4);background:linear-gradient(180deg, rgba(239,68,68,.20), rgba(239,68,68,.12))}
</style>
</head>
<body>
<header class="appbar">
  <div class="appbar-inner">
    <div class="brand"><div class="logo"></div>EscapePlan Attendance Tracker</div>
    <div class="pill" id="dataStatus" title="Tap to retry">Loading roster…</div>
  </div>
</header>

<main class="wrap">

  <section class="panel">
    <div class="h">Identify Yourself</div>
    <div class="b">
      <label>Mark as</label>
      <div class="seg" id="typeSeg">
        <button type="button" data-type="Login"  class="active">Login</button>
        <button type="button" data-type="Logout">Logout</button>
      </div>

      <div class="grid grid-3" style="margin-top:10px">
        <div>
          <label>City</label>
          <select id="city"><option value="">Select City</option></select>
        </div>
        <div>
          <label>Mall</label>
          <select id="mall"><option value="">Select Mall</option></select>
        </div>
        <div>
          <label>Your Name</label>
          <select id="rep"><option value="">Select Your Name</option></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <span id="storeIdBadge" class="badge" style="display:none"></span>
        <span id="refBadge" class="badge" style="display:none"></span>
      </div>
      <div class="muted" style="margin-top:8px">Choose type, then City/Mall/Name. Next allow location & camera.</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Location</div>
    <div class="b">
      <div class="row">
        <button id="locBtn" class="btn primary" type="button">Use My Location</button>
        <span id="locStatus" class="badge">Waiting…</span>
      </div>
      <div class="row" style="margin-top:10px">
        <span>Distance to store:</span>
        <strong id="distance" style="font-size:18px;letter-spacing:.3px">— m</strong>
        <span id="proximity" class="badge" style="display:none"></span>
      </div>
      <div class="muted" id="addrLine" style="margin-top:6px"></div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Photo</div>
    <div class="b">
      <input id="photo" type="file" accept="image/*" capture="environment">
      <div style="margin-top:10px">
        <img id="preview" class="preview" style="display:none" alt="Preview">
      </div>
      <div class="muted" style="margin-top:6px">Photo is watermarked with type (Login/Logout), name, IST time, GPS & address.</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">Submit</div>
    <div class="b">
      <div class="row">
        <button id="submitBtn" class="btn primary" type="button" disabled>Submit Attendance</button>
        <button id="resetBtn" class="btn alt" type="button">Reset</button>
        <span id="readyHint" class="badge">Complete steps to enable</span>
      </div>

      <div id="resultBanner" class="banner">
        <h3 id="bannerTitle">Status</h3>
        <p id="bannerSub"></p>
      </div>

      <div class="muted" style="margin-top:8px">We save a server timestamp (IST), your GPS, status, address & photo URL in today’s tab.</div>
    </div>
  </section>

  <div class="footer">Privacy: location & camera are used only for attendance capture.</div>
</main>

<script>
/* prevent accidental form submit reload */
document.addEventListener('submit', e => { e.preventDefault(); e.stopPropagation(); });

/* ===== CONFIG ===== */
const ROSTER_SHEET_ID = '13od8p_pcVQsMGHVqhoI-bOrW3xDeOKNeM4rf0uc8PX4';
const ROSTER_TAB_NAME = 'Roster';
const GAS_WEBAPP_URL  = 'https://script.google.com/macros/s/AKfycbzUDKjO8sHe9tLB52OKFvnSyQxJWNARdaGDzWgvxd_P8p6_tp6a2Z-jG5ev8KTKsCTd/exec';

/* 3 sources: two opensheet mirrors, then Google GViz (direct) */
const ROSTER_SOURCES = [
  { kind:'json', url: `https://opensheet.elk.sh/${ROSTER_SHEET_ID}/${encodeURIComponent(ROSTER_TAB_NAME)}` },
  { kind:'json', url: `https://opensheet.vercel.app/${ROSTER_SHEET_ID}/${encodeURIComponent(ROSTER_TAB_NAME)}` },
  { kind:'gviz', url: `https://docs.google.com/spreadsheets/d/${ROSTER_SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(ROSTER_TAB_NAME)}` },
];

/* ===== STATE (with persistence) ===== */
const STATE_KEY = 'ep_att_state_v3';
let ROSTER = [];
let attendanceType = 'Login';
let selected = { city:'', mall:'', rep:'', storeId:'', refLat:null, refLon:null };
let userLat = null, userLon = null, lastAccuracy = null;
let watchId = null;
let photoBase64 = '';              // kept only in-memory (not persisted)
let addressText = '';
let clientTsIST = '';

const $ = id => document.getElementById(id);
const t = v => v==null ? '' : String(v).trim();
const num = v => { const x = parseFloat(String(v).replace(/,/g,'')); return Number.isFinite(x)?x:NaN; };

function saveState(partial={}){
  try{
    const st = {
      attendanceType, selected, userLat, userLon, lastAccuracy,
      addressText, clientTsIST,
      ...partial
    };
    // DO NOT store photoBase64 to keep memory low on small phones
    sessionStorage.setItem(STATE_KEY, JSON.stringify(st));
  }catch{}
}
function loadState(){
  try{ const s = sessionStorage.getItem(STATE_KEY); return s ? JSON.parse(s) : null; }catch{ return null; }
}
function clearState(){ try{ sessionStorage.removeItem(STATE_KEY); }catch{} }

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') saveState({ reason:'hidden' });
});

/* ===== HELPERS ===== */
function uniq(a){ return Array.from(new Set(a.filter(x => t(x) !== ''))); }
function haversineMeters(lat1, lon1, lat2, lon2){
  const toRad = d=>d*Math.PI/180, R=6371000;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}
function nowIST(){ return new Date().toLocaleString('en-IN',{ timeZone:'Asia/Kolkata', hour12:false }); }

let lastGeocodeAt = 0;
async function reverseGeocodeThrottled(lat, lon){
  const now = Date.now();
  if (now - lastGeocodeAt < 15000) return addressText; // 15s throttle
  lastGeocodeAt = now;
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=16&addressdetails=1`;
    const res = await fetch(url, { headers:{ 'Accept':'application/json' }});
    const j = await res.json();
    return j.display_name || '';
  }catch{ return addressText; }
}

function fetchWithTimeout(url, {ms=15000, asText=false}={}){
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), ms);
  return fetch(url, { headers:{'Accept': asText?'text/plain':'application/json'}, cache:'no-store', signal:ctrl.signal })
    .then(r => { if(!r.ok) throw new Error(`HTTP ${r.status}`); return asText ? r.text() : r.json(); })
    .finally(()=>clearTimeout(timer));
}

/* Parse Google GViz response to array-of-objects */
function parseGViz(gvizText){
  const start = gvizText.indexOf('{');
  const end   = gvizText.lastIndexOf('}');
  if (start < 0 || end < 0) throw new Error('GViz parse error');
  const j = JSON.parse(gvizText.slice(start, end+1));
  const cols = (j.table.cols||[]).map(c => (c.label || c.id || '').trim());
  const rows = (j.table.rows||[]).map(r => (r.c||[]).map(c => (c ? c.v : '')));
  const out = rows.map(arr => {
    const o = {};
    cols.forEach((k,i)=>{ o[k] = arr[i]; });
    return o;
  });
  return out;
}

/* Load roster with retries & 3 fallbacks */
async function loadRoster(){
  const status = $("dataStatus");
  status.textContent = "Loading roster…";

  const attempts = [];
  // try each source up to 2 attempts with small backoff
  for (const src of ROSTER_SOURCES){
    for (let i=0;i<2;i++){
      attempts.push(async ()=>{
        if (src.kind === 'json'){
          return await fetchWithTimeout(src.url, {ms:15000, asText:false});
        } else {
          const txt = await fetchWithTimeout(src.url, {ms:18000, asText:true});
          return parseGViz(txt);
        }
      });
    }
  }

  let lastErr = null;
  for (let i=0;i<attempts.length;i++){
    try{
      const raw = await attempts[i]();
      ROSTER = raw.map(row => { const o={}; Object.keys(row).forEach(k=>o[String(k).trim().toLowerCase()]=row[k]); return o; });
      const cities = uniq(ROSTER.map(r => t(r.city)));
      $("city").innerHTML = `<option value="">Select City</option>` + cities.sort().map(c=>`<option>${c}</option>`).join('');
      status.textContent = `Loaded ${ROSTER.length} rows`;
      applyRestoredState(); // if any
      return;
    }catch(e){
      lastErr = e;
      status.textContent = `Retrying… (${i+1})`;
      await new Promise(r => setTimeout(r, 600));
    }
  }
  $("city").innerHTML = `<option value="">Failed to load roster</option>`;
  status.textContent = "Load failed — tap to retry";
}

/* ===== restore selection if we have it ===== */
let RESTORED = loadState();
function applyRestoredState(){
  if (!(RESTORED && RESTORED.selected)) return;

  attendanceType = RESTORED.attendanceType || 'Login';
  document.querySelectorAll('#typeSeg button').forEach(b=>{
    b.classList.toggle('active', b.dataset.type === attendanceType);
  });

  if (RESTORED.selected.city){
    $("city").value = RESTORED.selected.city;
    selected.city = RESTORED.selected.city;

    const malls = uniq(ROSTER.filter(r => t(r.city)===t(selected.city)).map(r => t(r.mall)));
    $("mall").innerHTML = `<option value="">Select Mall</option>` + malls.sort().map(m=>`<option>${m}</option>`).join('');

    if (RESTORED.selected.mall){
      $("mall").value = RESTORED.selected.mall;
      selected.mall = RESTORED.selected.mall;

      const reps = uniq(ROSTER.filter(r => t(r.city)===t(selected.city) && t(r.mall)===t(selected.mall)).map(r => t(r.salesperson)));
      $("rep").innerHTML = `<option value="">Select Your Name</option>` + reps.sort().map(r=>`<option>${r}</option>`).join('');

      if (RESTORED.selected.rep){
        $("rep").value = RESTORED.selected.rep;
        selected.rep = RESTORED.selected.rep;

        const row = ROSTER.find(r => t(r.city)===t(selected.city) && t(r.mall)===t(selected.mall) && t(r.salesperson)===t(selected.rep)) || {};
        selected.storeId = t(row['store id']);
        selected.refLat  = num(row['ref lat']);
        selected.refLon  = num(row['ref lon']);
        if (selected.storeId){ $("storeIdBadge").textContent = "Store ID: " + selected.storeId; $("storeIdBadge").style.display="inline-flex"; }
        if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
          $("refBadge").textContent = `Ref: ${selected.refLat.toFixed(5)}, ${selected.refLon.toFixed(5)}`;
          $("refBadge").style.display="inline-flex";
        }
      }
    }
  }

  if (Number.isFinite(RESTORED.userLat) && Number.isFinite(RESTORED.userLon)){
    userLat = RESTORED.userLat; userLon = RESTORED.userLon; lastAccuracy = RESTORED.lastAccuracy||null;
    clientTsIST = RESTORED.clientTsIST || '';
    $("locStatus").textContent = `Live: ${userLat.toFixed(5)}, ${userLon.toFixed(5)}${lastAccuracy?` (±${lastAccuracy}m)`:''}`;
    if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
      const m = haversineMeters(userLat,userLon,selected.refLat,selected.refLon);
      $("distance").textContent = `${m} m`; setProximityBadge(m);
    }
  }
  if (RESTORED.addressText){ addressText = RESTORED.addressText; $("addrLine").textContent = `Address: ${addressText}`; }

  updateSubmitEnabled();
  RESTORED = null;
}

/* ===== UI helpers ===== */
function setProximityBadge(m){
  const el = $("proximity"); el.style.display="inline-flex";
  if (m < 100){ el.textContent = "OK (<100m)"; el.className = "badge ok"; }
  else if (m <= 250){ el.textContent = "Check (100–250m)"; el.className = "badge warn"; }
  else { el.textContent = "Not captured (>250m)"; el.className = "badge bad"; }
}
function updateSubmitEnabled(){
  const ready = selected.city && selected.mall && selected.rep &&
                userLat!=null && userLon!=null && !!photoBase64;
  $("submitBtn").disabled = !ready;
  $("readyHint").textContent = ready ? "Ready to submit" : "Complete steps to enable";
}

/* ===== interactions ===== */
$("dataStatus").addEventListener("click", loadRoster);

document.querySelectorAll('#typeSeg button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#typeSeg button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    attendanceType = btn.dataset.type || 'Login';
    saveState({ attendanceType });
  });
});

$("city").addEventListener("change", ()=>{
  selected.city = $("city").value;
  const malls = uniq(ROSTER.filter(r => t(r.city)===t(selected.city)).map(r => t(r.mall)));
  $("mall").innerHTML = `<option value="">Select Mall</option>` + malls.sort().map(m=>`<option>${m}</option>`).join('');
  $("rep").innerHTML = `<option value="">Select Your Name</option>`;
  ["storeIdBadge","refBadge"].forEach(id => $(id).style.display="none");
  saveState(); updateSubmitEnabled();
});
$("mall").addEventListener("change", ()=>{
  selected.mall = $("mall").value;
  const reps = uniq(ROSTER.filter(r => t(r.city)===t(selected.city) && t(r.mall)===t(selected.mall)).map(r => t(r.salesperson)));
  $("rep").innerHTML = `<option value="">Select Your Name</option>` + reps.sort().map(r=>`<option>${r}</option>`).join('');
  ["storeIdBadge","refBadge"].forEach(id => $(id).style.display="none");
  saveState(); updateSubmitEnabled();
});
$("rep").addEventListener("change", ()=>{
  selected.rep = $("rep").value;
  const row = ROSTER.find(r => t(r.city)===t(selected.city) && t(r.mall)===t(selected.mall) && t(r.salesperson)===t(selected.rep)) || {};
  selected.storeId = t(row['store id']);
  selected.refLat  = num(row['ref lat']);
  selected.refLon  = num(row['ref lon']);
  if (selected.storeId){ $("storeIdBadge").textContent = "Store ID: " + selected.storeId; $("storeIdBadge").style.display="inline-flex"; }
  if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
    $("refBadge").textContent = `Ref: ${selected.refLat.toFixed(5)}, ${selected.refLon.toFixed(5)}`;
    $("refBadge").style.display="inline-flex";
  }
  saveState(); updateSubmitEnabled();
});

/* ===== GEO ===== */
$("locBtn").addEventListener("click", ()=>{
  if (!navigator.geolocation){ $("locStatus").textContent = "Geolocation not supported"; return; }
  $("locStatus").textContent = "Requesting permission…";
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  watchId = navigator.geolocation.watchPosition(
    async pos=>{
      userLat = pos.coords.latitude; userLon = pos.coords.longitude;
      lastAccuracy = Math.round(pos.coords.accuracy||0);
      clientTsIST = nowIST();
      $("locStatus").textContent = `Live: ${userLat.toFixed(5)}, ${userLon.toFixed(5)} (±${lastAccuracy}m)`;
      if (Number.isFinite(selected.refLat) && Number.isFinite(selected.refLon)){
        const m = haversineMeters(userLat,userLon,selected.refLat,selected.refLon);
        $("distance").textContent = `${m} m`; setProximityBadge(m);
      }
      addressText = await reverseGeocodeThrottled(userLat, userLon);
      $("addrLine").textContent = addressText ? `Address: ${addressText}` : '';
      saveState(); updateSubmitEnabled();
    },
    err=>{ $("locStatus").textContent = "Location denied or unavailable"; },
    { enableHighAccuracy:true, maximumAge:7000, timeout:20000 }
  );
});

/* ===== PHOTO (watermark) ===== */
$("photo").addEventListener("click", ()=>{ saveState({ reason:'before-camera' }); });
$("photo").addEventListener("change", async (e)=>{
  const f = e.target.files && e.target.files[0]; if (!f) return;
  const reader = new FileReader();
  reader.onload = async ()=>{
    const img = new Image();
    img.onload = async ()=>{
      const MAX = 1280, s = Math.min(1, MAX/img.width, MAX/img.height);
      const w = Math.round(img.width*s), h = Math.round(img.height*s);
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      ctx.fillStyle = 'rgba(0,0,0,0.58)'; ctx.fillRect(0, h-86, w, 86);
      ctx.fillStyle = '#fff'; ctx.font = '16px system-ui, Segoe UI, Roboto, Arial';
      const ts = clientTsIST || nowIST();
      const line0 = `${attendanceType.toUpperCase()} • ${selected.rep || '—'}`;
      const line1 = `${selected.city || '-'} / ${selected.mall || '-'}`;
      const line2 = `${ts} • ${userLat?.toFixed(5)||'-'},${userLon?.toFixed(5)||'-'} (±${lastAccuracy||'-'}m)`;
      ctx.fillText(line0, 10, h-62);
      ctx.fillText(line1, 10, h-42);
      ctx.fillText(line2, 10, h-20);
      photoBase64 = canvas.toDataURL('image/jpeg', 0.85);
      $("preview").src = photoBase64; $("preview").style.display = "block";
      updateSubmitEnabled(); // no photo in sessionStorage to save memory
    };
    img.src = reader.result;
  };
  reader.readAsDataURL(f);
});

/* ===== Result banner (shows mall, distance, time) ===== */
function showBanner(kind, distance, receiptId){
  const bn = $("resultBanner"), title = $("bannerTitle"), sub = $("bannerSub");
  const mallName = selected.mall || '—';
  const whenIST  = clientTsIST || nowIST();
  const distTxt  = (typeof distance === 'number') ? `${distance} m` : '— m';

  bn.className = "banner " + (kind==="ok"?"ok":kind==="warn"?"warn":"bad");

  if (kind==="ok"){
    title.textContent = `${attendanceType} captured ✅`;
    sub.textContent = `Mall: ${mallName} • Distance: ${distTxt} • Time (IST): ${whenIST}${receiptId?` • Receipt: ${receiptId}`:''}`;
  } else if (kind==="warn"){
    title.textContent = "Please check ⚠️";
    sub.textContent = `Mall: ${mallName} • Distance: ${distTxt} • Time (IST): ${whenIST}. If required, go to the entrance and retake.`;
  } else {
    title.textContent = `${attendanceType} NOT captured ❌`;
    sub.textContent = `Mall: ${mallName} • Distance: ${distTxt} • Time (IST): ${whenIST}. Go to the store entrance, reload and take attendance again.`;
  }
  bn.style.display = "block";
}

/* ===== Submit ===== */
$("submitBtn").addEventListener("click", async ()=>{
  const btn = $("submitBtn");
  btn.textContent = "Submitting…"; btn.disabled = true;

  const payload = {
    attendanceType,
    city: selected.city, mall: selected.mall, salesperson: selected.rep,
    storeId: selected.storeId || '',
    userLat, userLon, accuracy: lastAccuracy,
    address: addressText, clientTimestampIST: clientTsIST || nowIST(),
    photoBase64
  };

  try{
    const res = await fetch(GAS_WEBAPP_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    let data; try{ data = JSON.parse(text); }catch{ throw new Error('Server not JSON: ' + text.slice(0,120)); }

    if (data.ok){
      const d = typeof data.distanceMeters === 'number' ? data.distanceMeters : null;
      if (d!=null){
        if (d < 100)      showBanner("ok", d, data.receiptId);
        else if (d<=250)  showBanner("warn", d, data.receiptId);
        else              showBanner("bad", d, data.receiptId);
      } else {
        showBanner("ok", null, data.receiptId);
      }
      btn.textContent = "Submitted ✓"; // stays disabled
      clearState(); // done (we keep photo only in memory)
    } else {
      btn.textContent = "Submit Attendance"; btn.disabled = false;
      showBanner("bad", null, null);
      $("bannerTitle").textContent = "Submission failed";
      $("bannerSub").textContent  = (data.error || "Check network and try again.");
      saveState();
    }
  }catch(e){
    btn.textContent = "Submit Attendance"; btn.disabled = false;
    showBanner("bad", null, null);
    $("bannerTitle").textContent = "Network error";
    $("bannerSub").textContent  = "Please check your connection and try again.";
    saveState();
  }
});

/* ===== Reset ===== */
$("resetBtn").addEventListener("click", ()=>{
  ["city","mall","rep"].forEach(id => $(id).selectedIndex = 0);
  selected = { city:'', mall:'', rep:'', storeId:'', refLat:null, refLon:null };
  userLat = userLon = null; lastAccuracy = null; addressText=''; clientTsIST='';
  photoBase64='';
  $("preview").style.display = "none";
  ["storeIdBadge","refBadge"].forEach(id => $(id).style.display="none");
  $("locStatus").textContent = "Waiting…"; $("distance").textContent = "— m"; $("proximity").style.display="none"; $("addrLine").textContent='';
  $("resultBanner").style.display = "none";
  $("submitBtn").textContent = "Submit Attendance"; $("submitBtn").disabled = true;
  $("readyHint").textContent = "Complete steps to enable";
  if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  saveState();
});

/* ===== Boot ===== */
window.addEventListener('pageshow', ()=>{ /* restore if browser kept state */ });
loadRoster();
</script>
</body>
</html>
